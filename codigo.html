<!DOCTYPE html>
<html>
<head>
  <title>Coda Data Map</title>
  <!-- Include the config.js file for other configuration information -->
  <script src="config.js"></script>
  <!-- Include the Google Maps JavaScript API with your API key from config.js -->
  <script>
    // Callback function to initialize the map after the Google Maps API is loaded
    function initMap() {
      var googleMapsApiKey = getGoogleMapsApiKey(); // Function to retrieve API key from config.js

      function getGoogleMapsApiKey() {
        if (typeof googleMapsApiKey === "undefined") {
          console.error("Google Maps API key is undefined. Please check config.js.");
          return "";
        } else {
          return googleMapsApiKey;
        }
      }

      var map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 0, lng: 0 },
        zoom: 10
      });

      // Create an info window for displaying marker names
      var infoWindow = new google.maps.InfoWindow();

      // Create an empty LatLngBounds object to contain all markers
      var bounds = new google.maps.LatLngBounds();

      // Fetch data from Coda API using values from config.js
      fetch(codaApiUrl, {
        headers: {
          "Authorization": "Bearer " + codaApiToken
        }
      })
      .then(response => response.json())
      .then(data => {
        var codaData = data.items;

        // Loop through the data and add markers
        for (var i = 0; i < codaData.length; i++) {
          var name = codaData[i].values.Name;
          var latitude = parseFloat(codaData[i].values.Latitude);
          var longitude = parseFloat(codaData[i].values.Longitude);

          // Check if latitude and longitude are valid numbers
          if (!isNaN(latitude) && !isNaN(longitude)) {
            var marker = new google.maps.Marker({
              map: map,
              position: { lat: latitude, lng: longitude },
              title: name
            });

            // Add the marker's position to the bounds object
            bounds.extend(new google.maps.LatLng(latitude, longitude));

            // Add a click event listener to open the info window when a marker is clicked
            marker.addListener('click', function() {
              infoWindow.setContent(this.getTitle()); // Set the content of the info window to the marker's title (name)
              infoWindow.open(map, this); // Open the info window above the clicked marker
            });
          } else {
            console.warn("Skipping marker with invalid coordinates: " + name);
          }
        }

        // Fit the map to the bounds containing all valid markers
        map.fitBounds(bounds);
      })
      .catch(error => {
        console.error("Failed to fetch data from Coda API: " + error);
      });
    }
  </script>
</head>
<body>
  <!-- Add a link that reloads the current page above your existing code -->
  <a href="#" onclick="location.reload();">Refresh Page</a>
  
  <div id="map" style="width: 800px; height: 600px;"></div>

  <!-- Initialize the map when the page is loaded -->
  <script>
    initMap();
  </script>
</body>
</html>
